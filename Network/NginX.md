# NginX

NginX는 일단 **서버**를 만드는 도구임을 알고 시작하자.

### 어휘 정리

~~프론트 엔드 서버~~ => 웹 서버

~~백엔드 서버~~ => API 서버

백엔드라고 하면 api 와 서버와 등등을 다 퉁쳐서 말하는 것.

## 웹 서버와 API 서버의 동작과 NginX의 역할

### 웹 서버 통신에 대해 가지고 있던 오해

API 서버에게 보내는 요청은 웹 서버가 직접 보내는 것이라고 생각했다.

![image](https://user-images.githubusercontent.com/40619551/66766613-76d56d00-eee9-11e9-9874-7bc386d86dbe.png)

### 실제 API 요청 동작 방식

하지만 실제로는 브라우저가 API 서버에 요청을 날리는 방식으로 동작한다.

![image](https://user-images.githubusercontent.com/40619551/66766670-9ff5fd80-eee9-11e9-9544-5b5114c25195.png)

### 라우터로서의 NginX

이제까지 만들었던 express 서버는 3000포트에서만 동작을 했다. 따라서 본 서버에 접근하게 하기 위해서는 클라우드 서버에 3000포트를 열고 3000포트에 직접 연결하는 삽질을 했었다. 하지만 nginx를 이용하면 이 짓을 하지 않아도 된다.

NginX는 기본적으로 80포트에 붙어있는 친구이다. 이 친구는 라우터의 역할을 할 수 있는데, 80 포트로 일반적인 웹 서버 요청이 왔을 경우 (example.com:80/index) 이를 내부의 3000 포트로 연결시켜줄 수 있다.

![image](https://user-images.githubusercontent.com/40619551/66767052-8a350800-eeea-11e9-88e9-14ed1b57f853.png)

### 프록시 서버로서의 NginX

NginX로 리버스 프록시 서버를 만들 수 있다. (자세한 내용은 Proxy 문서 참고) 하지만 프록시 서버를 따로 만들기 위해서는 클라우드가 하나 더 필요하다. 우리는 돈이 없기 때문에 **웹 서버 역할을 하는 NginX 에게 프록시 서버의 역할 또한 위임할 것이다. **

1. NginX는 uri 를 보고 요청이 웹 서버 요청인지, api 요청인지 구분한다.
2. 요청이 전자일 경우 3000포트(웹 node js 서버) 에 라우팅
3. 요청이 후자일 경우 3030포트(API 서버) 에 라우팅 해준다.

따라서 API 요청이 날아오면, 웹 서버 NginX로 일단 들어가고, API 용 uri임이 판단 되면 적합한 API 서버를 골라 라우팅 해준다. (물론 우리는 하나밖에 없다.)

![image](https://user-images.githubusercontent.com/40619551/66768122-ce290c80-eeec-11e9-878b-a4fd285ccee4.png)

물론 유감스럽게도 우리는 돈이 없기 때문에 API 서버도 사실은 다른 포트를 통해 같은 클라우드에 있을 것이다.

### 돈이 많은 큰 서비스는 서버를 어떻게 관리할까

아래와 같이 로드 밸런서 (reverse proxy로 대체 가능) 를 사이에 두고 통신을 하는 방식으로 관리한다.

![1571072036522](C:\Users\Jack\AppData\Roaming\Typora\typora-user-images\1571072036522.png)

### 덤) Load Balancer가 죽으면 망하는거 아닌가?

맞다. 저 그림에서는 사실 빼먹은 부분이 있다. 사실 로드 밸런서는 하나씩만 있는 것이 아니라 비상용 로드 밸런서가 항상 같이 있다. 이 비상용 로드 밸런서는 primary 밸런서와 동일하게 동작 하기 위해 API 서버도 연결되어 있지만 연결은 되어 있지 않은 상태인 것이다. 그러다가 프라임 밸런서가 죽으면 얘로 대체되는 구조이다.

![image](https://user-images.githubusercontent.com/40619551/66769366-e6e6f180-eeef-11e9-9d56-080c0cb78739.png)

